:root { --teal: #008080; --green: #2e8b57; --orange: #ff8c00; --gold: #ffd700; }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
body { margin: 0; background: linear-gradient(135deg, var(--teal), var(--green)); color: white; font-family: sans-serif; min-height: 100vh; display: flex; justify-content: center; overflow-x: hidden; }

button:active { transform: scale(0.96); opacity: 0.9; }
.screen { width: 95%; max-width: 450px; margin: 15px auto; padding: 25px; background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); border-radius: 30px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }

/* --- HOME UI --- */import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// --- Firebase Configuration ---
const firebaseConfig = {
    apiKey: "AIzaSyConuxhGCtGvJaa6TZ1bkUvlOhhTdyTgZE",
    authDomain: "flip7share.firebaseapp.com",
    databaseURL: "https://flip7share-default-rtdb.firebaseio.com",
    projectId: "flip7share",
    storageBucket: "flip7share.firebasestorage.app",
    messagingSenderId: "467127126520",
    appId: "1:467127126520:web:0646f4fc19352eaa11ee0d"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// --- State Variables ---
let gameCode = localStorage.getItem('f7_code'), 
    myName = localStorage.getItem('f7_name') || "";
let usedCards = [], bonuses = [], mult = 1, busted = false, currentGrandTotal = 0;
let targetPlayerCount = 4, hasCelebrated = false;

// --- Host/Join Logic ---
window.adjustCount = (v) => {
    let newVal = targetPlayerCount + v;
    if (newVal >= 1 && newVal <= 20) {
        targetPlayerCount = newVal;
        const disp = document.getElementById('playerCountDisplay');
        if (disp) disp.innerText = targetPlayerCount;
    }
};

window.hostGameFromUI = async () => {
    if(!myName || myName.trim() === "") return alert("Please enter your name first!");
    const newCode = Math.floor(100000 + Math.random() * 900000).toString();
    gameCode = newCode;
    localStorage.setItem('f7_code', gameCode);
    try {
        await set(ref(db, `games/${gameCode}`), { 
            host: myName, 
            targetCount: targetPlayerCount, 
            status: "waiting", 
            roundNum: 1 
        });
        await set(ref(db, `games/${gameCode}/players/${myName}`), { 
            name: myName, 
            history: [0], 
            submitted: false 
        });
        onValue(ref(db, `games/${gameCode}`), syncApp);
    } catch (e) { alert("Hosting failed: " + e.message); }
};

window.openJoinPopup = () => {
    let c = prompt("Enter 6-digit code:");
    if(c && myName) { 
        gameCode = c; 
        localStorage.setItem('f7_code', c); 
        joinGame(c); 
    } else if (!myName) {
        alert("Enter your name on the home screen first!");
    }
};

async function joinGame(code) {
    const pRef = ref(db, `games/${code}/players/${myName}`);
    const snap = await get(pRef);
    if (!snap.exists()) {
        await set(pRef, { name: myName, history: [0], submitted: false });
    }
    onValue(ref(db, `games/${code}`), syncApp);
}

// --- Gameplay Actions ---
window.triggerBust = () => {
    busted = !busted;
    if(busted) { 
        usedCards = []; bonuses = []; mult = 1; hasCelebrated = false; 
    }
    updateUI();
};

window.toggleMod = (id, val) => {
    if(id === 'm2') mult = (mult === 2) ? 1 : 2;
    else bonuses.includes(val) ? bonuses = bonuses.filter(b=>b!==val) : bonuses.push(val);
    updateUI();
};

window.submitRound = async () => {
    const snap = await get(ref(db, `games/${gameCode}`));
    const rNum = snap.val().roundNum;
    const score = busted ? 0 : (usedCards.reduce((a,b)=>a+b, 0) * mult) + bonuses.reduce((a,b)=>a+b, 0) + (usedCards.length === 7 ? 15 : 0);
    
    const roundState = { score, usedCards: [...usedCards], bonuses: [...bonuses], mult, busted };
    let h = (await get(ref(db, `games/${gameCode}/players/${myName}`))).val().history || [0];
    
    h[rNum] = roundState;
    await update(ref(db, `games/${gameCode}/players/${myName}`), { history: h, submitted: true });
    
    // Reset local calculator state for next time
    usedCards = []; bonuses = []; mult = 1; busted = false; 
    updateUI();
};

// Allows a player to go back from the leaderboard to the calculator
window.editScore = async () => {
    if (!gameCode || !myName) return;
    await update(ref(db, `games/${gameCode}/players/${myName}`), { submitted: false });
};

window.readyForNextRound = async () => {
    const snap = await get(ref(db, `games/${gameCode}`));
    const up = { [`games/${gameCode}/roundNum`]: snap.val().roundNum + 1 };
    for (let p in snap.val().players) up[`games/${gameCode}/players/${p}/submitted`] = false;
    await update(ref(db), up);
};

// --- UI Sync & Display ---
function updateUI() {
    let sum = usedCards.reduce((a, b) => a + b, 0);
    let totalB = bonuses.reduce((a, b) => a + b, 0);
    const hasF7 = (usedCards.length === 7);
    
    if(hasF7 && !hasCelebrated && !busted) {
        document.getElementById('celebration-overlay').style.display = 'flex';
        hasCelebrated = true;
    }
    if(!hasF7) hasCelebrated = false;

    let roundScore = busted ? 0 : (sum * mult) + totalB + (hasF7 ? 15 : 0);
    const rDisp = document.getElementById('round-display');
    const gDisp = document.getElementById('grand-display');
    
    if (rDisp) rDisp.innerText = busted ? "BUST" : roundScore;
    if (gDisp) gDisp.innerText = currentGrandTotal + roundScore;
    
    document.getElementById('bust-toggle-btn').className = busted ? "big-btn bust-btn bust-active" : "big-btn bust-btn";
    const banner = document.getElementById('flip7-banner');
    if (banner) banner.style.display = (hasF7 && !busted) ? 'block' : 'none';

    const grid = document.getElementById('cardGrid');
    if(grid) {
        for(let i=0; i<=12; i++) {
            const b = grid.children[i];
            if(b) b.style.background = usedCards.includes(i) ? "var(--teal)" : "rgba(255,255,255,0.2)";
        }
    }
    
    const m2Btn = document.getElementById('btn-m2');
    if (m2Btn) m2Btn.className = (mult === 2) ? "mod-btn-active" : "";
    
    [2,4,6,8,10].forEach(v => {
        const b = document.getElementById('btn-p' + v);
        if(b) b.className = bonuses.includes(v) ? "mod-btn-active" : "";
    });
}

function syncApp(snap) {
    const data = snap.val(); if(!data) return;
    const me = data.players[myName]; if(!me) return;
    const playersArr = Object.values(data.players || {});

    // Calculate grand total from history up to the round before the current one
    const history = me.history || [0];
    currentGrandTotal = history.reduce((acc, entry, idx) => {
        if (idx > 0 && idx < data.roundNum) {
            return acc + (typeof entry === 'object' ? entry.score : entry);
        }
        return acc;
    }, 0);
    
    if (data.status === "waiting") {
        window.showScreen('lobby-screen');
        document.getElementById('roomDisplayLobby').innerText = "Game: " + gameCode;
        document.getElementById('lobby-status').innerText = `Joined: ${playersArr.length} / ${data.targetCount}`;
        document.getElementById('player-list').innerHTML = playersArr.map(p => `<div class="p-row"><b>${p.name}</b></div>`).join("");
        
        if(playersArr.length >= data.targetCount && data.host === myName) {
            update(ref(db, `games/${gameCode}`), { status: "active" });
        }
    } else {
        window.showScreen('game-screen');
        document.getElementById('roomCodeDisplay').innerText = `CODE: ${gameCode} | R${data.roundNum}`;
        document.getElementById('calc-view').style.display = me.submitted ? 'none' : 'block';
        document.getElementById('waiting-view').style.display = me.submitted ? 'block' : 'none';
        
        const sorted = playersArr.map(p => ({ 
            ...p, 
            total: (p.history || []).reduce((a,b) => a + (typeof b === 'object' ? b.score : b), 0) 
        })).sort((a,b) => b.total - a.total);
        
        document.getElementById('leaderboard').innerHTML = sorted.map(p => `
            <div class="p-row ${p.total >= 200 ? 'threshold-reached' : ''}">
                <b>${p.name} ${p.submitted ? '‚úÖ' : '‚è≥'}</b>
                <span>${p.total} ${p.total >= 200 ? 'üî•' : 'pts'}</span>
            </div>`).join("");
        
        document.getElementById('nextRoundBtn').style.display = (data.host === myName && playersArr.every(p => p.submitted)) ? 'block' : 'none';
    }
    updateUI();
}

// --- Navigation & App Setup ---
window.showScreen = (id) => {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    const target = document.getElementById(id);
    if (target) target.style.display = 'flex';
};

window.resumeGame = () => {
    if(gameCode) joinGame(gameCode);
};

window.leaveGame = () => { 
    if(confirm("Leave game?")) { 
        localStorage.removeItem('f7_code'); 
        location.reload(); 
    }
};

window.closeCelebration = () => {
    document.getElementById('celebration-overlay').style.display = 'none';
};

document.addEventListener('DOMContentLoaded', () => {
    // Name Input Sync
    const nInput = document.getElementById('userNameInput');
    if(nInput) {
        nInput.value = myName;
        nInput.oninput = () => { 
            myName = nInput.value; 
            localStorage.setItem('f7_name', myName); 
        };
    }

    // Resume Button Visibility
    if(gameCode) {
        const resBtn = document.getElementById('resume-btn');
        if(resBtn) resBtn.style.display = 'block';
    }

    // Generate Card Grid
    const grid = document.getElementById('cardGrid');
    if (grid) {
        grid.innerHTML = "";
        for(let i=0; i<=12; i++){
            let btn = document.createElement('button');
            btn.innerText = i;
            btn.onclick = () => { 
                if (busted) { 
                    busted = false; 
                    usedCards = [i]; 
                } else {
                    if(usedCards.includes(i)) usedCards = usedCards.filter(v=>v!==i); 
                    else if(usedCards.length < 7) usedCards.push(i);
                }
                updateUI(); 
            };
            grid.appendChild(btn);
        }
    }
    
    // Reset counter display to default
    const countDisp = document.getElementById('playerCountDisplay');
    if(countDisp) countDisp.innerText = targetPlayerCount;
});
.name-input-field { width: 100%; padding: 20px; border-radius: 20px; border: none; font-size: 1.8rem; font-weight: 900; text-align: center; color: var(--teal); background: white; margin-top: 10px; }
.counter-btn { width: 65px; height: 65px; border-radius: 15px; border: none; font-size: 2.2rem; background: white; color: var(--teal); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
.count-display { font-size: 3.8rem; font-weight: 900; min-width: 80px; text-align: center; }
.counter-row { display: flex; justify-content: center; align-items: center; gap: 30px; margin-bottom: 25px; width: 100%; }

/* Game Manager */
.game-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.15); padding: 12px 15px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.2); margin-bottom: 8px; }
.game-info { font-weight: 900; font-size: 1.1rem; cursor: pointer; flex: 1; }
.delete-single-btn { background: #ff4444; color: white; border: none; width: 40px; height: 40px; border-radius: 10px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
.delete-all-btn { width: 100%; margin-top: 15px; padding: 12px; background: #ff4444; color: white; border: none; border-radius: 12px; font-weight: 900; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; }

/* --- CALCULATOR --- */
.card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
.card-grid button { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 20px 0; border-radius: 15px; font-weight: bold; font-size: 1.4rem; min-height: 65px; }
.totals-row { display: flex; gap: 15px; width: 100%; }
.total-box { flex: 1; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); padding: 15px; text-align: center; background: rgba(0,0,0,0.2); }
.total-box.grand { background: white; color: var(--teal); border: none; }

/* --- LEADERBOARD & LIVE SYNC --- */
.p-row { display: flex; justify-content: space-between; padding: 18px; background: rgba(0,0,0,0.2); margin-bottom: 8px; border-radius: 15px; align-items: center; }
.busted-row { background: rgba(255, 68, 68, 0.2) !important; border: 1px solid #ff4444 !important; }
.live-icon { color: var(--gold); animation: pulse-live 1s infinite; margin-left: 5px; }
@keyframes pulse-live { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }

.top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.big-btn { width: 100%; padding: 24px; border-radius: 22px; border: none; font-weight: 900; font-size: 1.4rem; text-transform: uppercase; }
.submit-btn { background: var(--orange); color: white; }
.bust-btn { background: rgba(255,255,255,0.1); border: 2px solid white !important; height: 75px; font-size: 1.5rem; margin: 15px 0 25px 0 !important; }
.bust-active { background: #ff4444 !important; border-color: #ff4444 !important; }
.mod-btn-active { background: var(--orange) !important; border-color: white !important; }
.overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
.celebration-content { background: white; color: var(--teal); padding: 40px; border-radius: 30px; text-align: center; max-width: 80%; }
.banner { background: var(--gold); color: black; padding: 12px; border-radius: 12px; font-weight: 900; font-size: 0.9rem; text-align: center; margin-bottom: 10px; }
